name: Build Windows EXE

on:
  push:
    branches:
      - main
  # 添加触发条件，当打标签时也触发构建
  pull_request:
    branches:
      - main
  release:
    types: [created]

jobs:
  release-windows:
    runs-on: windows-latest

    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4
        with:
          submodules: "recursive"
          fetch-depth: 0

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'  # 指定一个稳定的 Node.js 版本
          cache: 'npm'

      - name: Install dependencies
        run: npm ci  # 使用 ci 而不是 install 以获得更可靠的构建

      - name: Build Windows EXE
        uses: samuelmeuli/action-electron-builder@v1.6.0
        with:
          # GitHub token for releasing
          github_token: ${{ secrets.GITHUB_TOKEN }}  # 使用默认的 GITHUB_TOKEN
          # 只构建 Windows 目标
          args: "--win --x64"
          # 只在打标签时发布 release
          release: ${{ startsWith(github.ref, 'refs/tags/v') }}

      - name: Upload Artifact (Windows EXE)
        uses: actions/upload-artifact@v4
        with:
          name: zyplayer-windows-exe
          path: |
            ./dist/*.exe
            ./dist/*.exe.blockmap
          if-no-files-found: error
          retention-days: 7
